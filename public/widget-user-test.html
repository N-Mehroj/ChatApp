<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Widget Test with User Identification</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 40px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
        }

        .info {
            background: #f0f7ff;
            border: 1px solid #b3d9ff;
            border-radius: 4px;
            padding: 15px;
            margin: 20px 0;
        }

        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        button {
            background: #3B82F6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #2563EB;
        }

        .form-group {
            margin: 15px 0;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input,
        textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üöÄ Chat Widget Test - User Identification</h1>

        <div class="info">
            <strong>Widget Function:</strong> Bu sahifa widget funksionalligini test qilish uchun yaratilgan.
            User ma'lumotlarini widget orqali yuborishni sinab ko'ramiz.
        </div>

        <!-- User Information Form -->
        <div class="test-section">
            <h3>üë§ Foydalanuvchi Ma'lumotlari</h3>
            <div class="form-group">
                <label for="userName">Ism:</label>
                <input type="text" id="userName" value="Sardor Boltayev" placeholder="Ismingizni kiriting">
            </div>
            <div class="form-group">
                <label for="userEmail">Email:</label>
                <input type="email" id="userEmail" value="sardor@example.com" placeholder="Email kiriting">
            </div>
            <div class="form-group">
                <label for="userPhone">Telefon:</label>
                <input type="tel" id="userPhone" value="+998901234567" placeholder="Telefon raqam">
            </div>
            <div class="form-group">
                <label for="userNotes">Qo'shimcha ma'lumot:</label>
                <textarea id="userNotes" placeholder="Qo'shimcha ma'lumotlar"
                    rows="3">Men yangi mijozman, yordam kerak.</textarea>
            </div>

            <button onclick="createSession()">Widget Session Yaratish</button>
            <button onclick="identifyUser()" id="identifyBtn" disabled>User Ma'lumotlarini Yuborish</button>
        </div>

        <!-- Message Testing -->
        <div class="test-section">
            <h3>üí¨ Xabar Yuborish</h3>
            <div class="form-group">
                <label for="messageText">Xabar:</label>
                <input type="text" id="messageText" value="Salom, yordam kerak!" placeholder="Xabar yozing">
            </div>
            <button onclick="sendMessage()" id="sendBtn" disabled>Xabar Yuborish</button>
        </div>

        <!-- Status Display -->
        <div class="test-section">
            <h3>üìä Test Status</h3>
            <div id="statusArea"></div>
        </div>

        <!-- Chat Messages -->
        <div class="test-section">
            <h3>üí≠ Chat Messages</h3>
            <div id="messagesArea"
                style="min-height: 100px; border: 1px solid #ddd; padding: 10px; border-radius: 4px;">
                Xabarlar bu yerda ko'rinadi...
            </div>
            <button onclick="loadMessages()" id="loadBtn" disabled>Xabarlarni Yuklash</button>
        </div>
    </div>

    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="//127.0.0.1:6001/socket.io/socket.io.js"></script>
    <script>
        let sessionId = null;
        let chatId = null;
        let socket = null;
        const apiKey = 'test-api-key-123'; // Test API key
        const baseUrl = window.location.origin;

        // Initialize WebSocket connection
        function initWebSocket() {
            if (socket) return;

            try {
                socket = io('127.0.0.1:6001', {
                    transports: ['websocket'],
                    forceNew: true
                });

                socket.on('connect', () => {
                    showStatus('üîó WebSocket ulanadi');

                    // Subscribe to widget session channel if we have sessionId
                    if (sessionId) {
                        socket.emit('join', `widget.session.${sessionId}`);
                    }
                });

                socket.on('disconnect', () => {
                    showStatus('‚ùå WebSocket uzildi');
                });

                // Listen for incoming messages
                socket.on('widget.message.sent', (data) => {
                    showStatus('üì® Yangi xabar keldi: ' + data.message.message);
                    setTimeout(loadMessages, 500); // Auto-refresh messages
                });

            } catch (error) {
                console.error('WebSocket connection error:', error);
                showStatus('‚ùå WebSocket ulanmadi: ' + error.message, 'error');
            }
        }

        function showStatus(message, type = 'success') {
            const statusArea = document.getElementById('statusArea');
            const timestamp = new Date().toLocaleTimeString();
            statusArea.innerHTML = `<div class="status ${type}">[${timestamp}] ${message}</div>`;
        }

        function showError(message) {
            showStatus(message, 'error');
        }

        async function createSession() {
            try {
                showStatus('Session yaratilmoqda...');

                // Initialize WebSocket first
                initWebSocket();

                const response = await axios.post(`${baseUrl}/api/widget/session`, {
                    api_key: apiKey,
                    visitor_id: 'test_visitor_' + Date.now(),
                });

                sessionId = response.data.session_id;
                chatId = response.data.chat_id;

                showStatus(`‚úÖ Session yaratildi! Session ID: ${sessionId}, Chat ID: ${chatId}`);

                // Subscribe to widget session channel
                if (socket && socket.connected) {
                    socket.emit('join', `widget.session.${sessionId}`);
                    showStatus('üîî Widget channel ga ulandi');
                }

                // Enable other buttons
                document.getElementById('identifyBtn').disabled = false;
                document.getElementById('sendBtn').disabled = false;
                document.getElementById('loadBtn').disabled = false;

            } catch (error) {
                console.error('Session creation error:', error);
                showError(`‚ùå Session yaratishda xatolik: ${error.response?.data?.error || error.message}`);
            }
        }

        async function identifyUser() {
            if (!sessionId) {
                showError('‚ùå Avval session yarating!');
                return;
            }

            try {
                showStatus('User ma\'lumotlari yuborilmoqda...');

                const userData = {
                    api_key: apiKey,
                    session_id: sessionId,
                    name: document.getElementById('userName').value,
                    email: document.getElementById('userEmail').value,
                    phone: document.getElementById('userPhone').value,
                    notes: document.getElementById('userNotes').value,
                    metadata: {
                        source: 'website',
                        page: 'test-page',
                        timestamp: new Date().toISOString()
                    }
                };

                const response = await axios.post(`${baseUrl}/api/widget/identify-user`, userData);

                showStatus(`‚úÖ User ma'lumotlari saqlandi! Name: ${response.data.session.visitor_name}`);

            } catch (error) {
                console.error('User identification error:', error);
                showError(`‚ùå User ma'lumotlarini saqlashda xatolik: ${error.response?.data?.error || error.message}`);
            }
        }

        async function sendMessage() {
            if (!sessionId) {
                showError('‚ùå Avval session yarating!');
                return;
            }

            const messageText = document.getElementById('messageText').value.trim();
            if (!messageText) {
                showError('‚ùå Xabar matnini kiriting!');
                return;
            }

            try {
                showStatus('Xabar yuborilmoqda...');

                const response = await axios.post(`${baseUrl}/api/widget/message`, {
                    api_key: apiKey,
                    session_id: sessionId,
                    message: messageText
                });

                showStatus(`‚úÖ Xabar yuborildi: "${messageText}"`);
                document.getElementById('messageText').value = '';

                // Auto-load messages
                setTimeout(loadMessages, 500);

            } catch (error) {
                console.error('Message send error:', error);
                showError(`‚ùå Xabar yuborishda xatolik: ${error.response?.data?.error || error.message}`);
            }
        }

        async function loadMessages() {
            if (!sessionId) {
                showError('‚ùå Avval session yarating!');
                return;
            }

            try {
                showStatus('Xabarlar yuklanmoqda...');

                const response = await axios.get(`${baseUrl}/api/widget/messages/${sessionId}`);
                const messages = response.data.messages || [];

                const messagesArea = document.getElementById('messagesArea');

                if (messages.length === 0) {
                    messagesArea.innerHTML = 'Hozircha xabarlar yo\'q.';
                } else {
                    messagesArea.innerHTML = messages.map(msg => {
                        const fromUser = msg.is_from_user ? 'Siz' : 'Agent';
                        const time = new Date(msg.created_at).toLocaleTimeString();
                        return `<div style="margin: 5px 0; padding: 8px; background: ${msg.is_from_user ? '#e3f2fd' : '#f5f5f5'}; border-radius: 4px;">
                            <strong>${fromUser}:</strong> ${msg.message}
                            <br><small style="color: #666;">${time}</small>
                        </div>`;
                    }).join('');
                }

                showStatus(`‚úÖ ${messages.length} ta xabar yuklandi`);

            } catch (error) {
                console.error('Messages load error:', error);
                showError(`‚ùå Xabarlarni yuklashda xatolik: ${error.response?.data?.error || error.message}`);
            }
        }

        // Auto-refresh messages every 5 seconds
        setInterval(() => {
            if (sessionId && chatId) {
                loadMessages();
            }
        }, 5000);
    </script>
</body>

</html>